## ✅ AI 午餐推薦主功能需求

### 🧠 對話啟動方式

使用者與系統互動以「對話」為主要操作介面，支援兩種啟動方式：

#### 1️⃣ 使用者提供詳細位置
提供地點資訊後，系統將自動解析座標與位址：

- 透過瀏覽器（Geolocation API）自動取得位置
- 使用 Google Maps 短網址（自動解析位置）
- 手動輸入地址、地標名稱或關鍵字

位置解析完成後，會顯示經緯度與鄰近地址資訊。

#### 2️⃣ 直接開始對話
若未提供精確位置，系統將從自然語言輸入中擷取關鍵資訊：

- 區域名稱（如：台北中山區）
- 餐點類型（如：火鍋、便當、燒烤）

---

### 🤖 AI 智能語意分析（最新實現）

#### 🧠 ChatGPT 增強語意理解
系統現在使用 ChatGPT-4o-mini 進行深度語意分析，能夠正確區分：

- **地址 vs 食物類型**：「龜山區東山鴨頭」→ 地址：龜山區 + 食物類型：東山鴨頭
- **店名 vs 食物名稱**：「信義區麥當勞」→ 連鎖店搜尋 vs 「龜山區東山鴨頭」→ 食物類型搜尋
- **具體食物映射**：東山鴨頭 → [鴨頭, 滷味, 小吃]；牛肉麵 → [牛肉麵, 麵食]

#### 🎯 智能搜尋關鍵字擴展
- **特殊食物自動映射**：
  - 東山鴨頭 → 鴨頭、滷味、小吃
  - 鹽酥雞 → 鹽酥雞、炸物、小吃  
  - 牛肉麵 → 牛肉麵、麵食
  - 臭豆腐 → 臭豆腐、小吃

#### 🔄 多層次備用機制
1. **ChatGPT 主要分析**：深度語意理解
2. **關鍵字檢測**：傳統模式匹配
3. **時間推薦**：根據用餐時段推薦
4. **天氣推薦**：根據天氣狀況推薦

---

### 📍 推薦規則設計

#### 預算推薦：
- **預算最高就平均200**

#### 🧊 根據「流汗指數」調整推薦範圍：

- **流汗指數 > 8** 且有精確座標 → 推薦距離 **200 公尺內**
- **體感較舒適** → 可延伸至 **800 公尺**
- **流汗越多 → 餐廳越近；體感越舒適 → 範圍放寬**

#### 🌡️ 餐點類型過濾邏輯：

- 若體感炎熱（流汗指數高），**不推薦高溫熱食**（如：火鍋、羊肉爐）
- 若體感偏冷，則**適度增加熱食類型的權重**

> ※ 餐點「熱度」將作為一項篩選指標納入推薦引擎。

#### 🌧️ 降雨提示：

- 若降雨機率高，主動提示使用者攜帶雨具（根據中央氣象署 API）

#### 📊 距離優先排序（最新實現）

- **主要排序方式**：依距離升冪排序（近距離優先）
- **距離計算**：雙重機制
  - 精確地理編碼計算
  - 備用距離估算（3km 預設值）
- **搜尋策略**：混搭多種餐點類型，每種類型限制數量

---

### 🔜 TODO：規劃中功能

- **評論語意分析（環境不適感判斷）**
  - 透過評論內容分析是否有「悶熱」、「吵雜」、「擁擠」等不適情境
  - 作為未來環境舒適度判斷的依據，進一步強化推薦品質
- **搜尋加速**
- **搜尋結果階段式輸出**
  - 如果可以，請讓搜尋結果先階段式輸出，讓使用者看到搜尋歷史，最後統整完成，再一次更新結果在UI上
- **價格區間判斷優化**
  - 現在仍然會有金額區間parse失誤的問題

## 🔄 新增與更新功能需求

### 🧭 Google Maps 分享網址支援

系統應支援分析新版 Google Maps 分享網址格式，例如：
```
https://share.google/uhP2gTiJrSrr49VZH
```


- 系統應該能正確解析該短網址並取得使用者位置（座標與地址）
- 若網址無法解析，應提供清楚的錯誤提示與手動輸入建議

---

### 💬 對話框輸入邏輯

- 對話介面支援 `Shift + Enter` 換行，使用者可輸入多行訊息
- `Enter` 仍作為送出訊息的快捷鍵

---

### 🧠 對話流程與位置記憶邏輯

#### 初始引導

- 系統啟動後主動詢問：「是否要提供目前位置？」
  - 若使用者提供位置（瀏覽器、地標、地址、Google Maps 短網址），則此為**主要查詢地點**
  - 若使用者回覆為否或跳過，則預設為模糊搜尋模式

#### 查詢位置記憶邏輯

- 使用者提供位置後，系統應**記憶目前查詢位置**
- 在後續對話中，若使用者再次提及新的地點（如貼上新地址、地標、短網址），則自動更新記憶位置為最新者
- 系統應在更新位置後主動提示使用者：「已更新查詢位置為 XXX」

#### 首次使用時輸入行為

- 若使用者**第一次對話即直接輸入餐點類型或區域（未提供地點）**，則視為開啟「自然語言搜尋」流程
- 不主動解析該輸入是否為地址或地點（避免誤判）

---

✅ 此邏輯將與 `taiwan_locations.py`、`google_maps.py` 的地址解析模組整合實作
