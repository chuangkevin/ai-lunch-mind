<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI é¤å»³æ¨è–¦ç³»çµ±</title>
  <style>
    body { background: linear-gradient(120deg, #f0f4ff 0%, #fff5f5 100%); margin: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    .chat-container { max-width: 480px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; padding: 0; display: flex; flex-direction: column; height: 85vh; }
    .chat-header { padding: 1.2em 1.5em; background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); color: #fff; border-radius: 16px 16px 0 0; font-size: 1.3em; font-weight: bold; letter-spacing: 1px; text-align: center; }
    .chat-subtitle { padding: 0 1.5em 1em; background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); color: #fff; font-size: 0.9em; opacity: 0.9; text-align: center; border-radius: 0 0 16px 16px; margin-bottom: 1em; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 0 1.5em 1.5em; display: flex; flex-direction: column; gap: 1.2em; }
    .msg { max-width: 85%; padding: 1em 1.2em; border-radius: 16px; font-size: 1.05em; line-height: 1.6; }
    .msg.user { align-self: flex-end; background: #ffe4e1; color: #d63384; border-bottom-right-radius: 4px; }
    .msg.bot { align-self: flex-start; background: #f8f9ff; color: #222; border-bottom-left-radius: 4px; box-shadow: 0 2px 8px #0001; }
    .restaurant-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1em; margin: 0.5em 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .restaurant-name { font-weight: bold; color: #ff6b6b; font-size: 1.1em; margin-bottom: 0.5em; }
    .restaurant-info { font-size: 0.95em; color: #666; line-height: 1.5; }
    .restaurant-rating { color: #ffa500; font-weight: bold; }
    .restaurant-distance { color: #007bff; font-weight: bold; }
    .restaurant-address { color: #6c757d; margin: 0.3em 0; }
    .restaurant-link { color: #007bff; text-decoration: none; font-size: 0.9em; }
    .restaurant-link:hover { text-decoration: underline; }
  .hours-row { margin-top: 0.5em; font-size: 0.92em; display: flex; align-items: center; gap: 8px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.8em; font-weight: 600; }
  .badge-open { background: #e8f7ee; color: #146c43; border: 1px solid #a3e6bf; }
  .badge-closed { background: #fdecea; color: #b42318; border: 1px solid #f5c2c7; }
  .badge-unknown { background: #eef2ff; color: #1e3a8a; border: 1px solid #c7d2fe; }
    .chat-input-area { display: flex; flex-direction: column; padding: 1.2em; border-top: 1px solid #e5e7eb; background: #f7fafc; border-radius: 0 0 16px 16px; }
    .input-row { display: flex; gap: 0.8em; margin-bottom: 0.8em; }
    .chat-input { flex: 1; padding: 0.8em 1em; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1em; outline: none; }
    .keyword-input { flex: 0.7; }
    .location-input { flex: 1.3; }
    .chat-send { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); color: #fff; border: none; border-radius: 8px; padding: 0.8em 1.5em; font-size: 1em; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; align-self: flex-start; }
    .chat-send:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3); }
    .example-text { font-size: 0.85em; color: #666; margin-top: 0.5em; }
    .loading { text-align: center; color: #666; font-style: italic; }
    @media (max-width: 600px) {
      .chat-container { max-width: 100vw; height: 100vh; border-radius: 0; margin: 0; }
      .chat-header, .chat-messages, .chat-input-area { padding-left: 1em; padding-right: 1em; }
      .input-row { flex-direction: column; gap: 0.5em; }
      .chat-send { align-self: stretch; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">ğŸ½ï¸ AI é¤å»³æ¨è–¦åŠ©æ‰‹</div>
    <div class="chat-subtitle">è¼¸å…¥åœ°å€å’Œæƒ³åƒçš„é£Ÿç‰©ï¼Œç«‹å³æ‰¾åˆ°é™„è¿‘ç¾é£Ÿï¼</div>
    <div class="chat-messages" id="chat-messages">
      <div class="msg bot">
        æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„é¤å»³æ¨è–¦åŠ©æ‰‹ ğŸ¤–<br><br>
        è«‹è¼¸å…¥ï¼š<br>
        ğŸ“ <strong>åœ°å€æˆ–ä½ç½®</strong>ï¼ˆæ”¯æ´ Google Maps çŸ­ç¶²å€ï¼‰<br>
        ğŸ´ <strong>æƒ³åƒçš„é£Ÿç‰©é¡å‹</strong><br><br>
        ä¾‹å¦‚ï¼š<br>
        â€¢ åœ°å€ï¼šå°åŒ—ä¸­å±±å€ï¼Œé£Ÿç‰©ï¼šç«é‹<br>
        â€¢ åœ°å€ï¼šhttps://maps.app.goo.gl/..ï¼Œé£Ÿç‰©ï¼šç¾Šè‚‰<br>
        â€¢ åœ°å€ï¼šå½°åŒ–å¤§ä½›ï¼Œé£Ÿç‰©ï¼šç‡’çƒ¤
      </div>
    </div>
    <div class="chat-input-area">
      <div class="input-row">
        <input class="chat-input location-input" id="location-input" type="text" placeholder="è¼¸å…¥åœ°å€ã€åœ°æ¨™æˆ– Google Maps çŸ­ç¶²å€..." autocomplete="off" />
        <input class="chat-input keyword-input" id="keyword-input" type="text" placeholder="æƒ³åƒä»€éº¼ï¼Ÿ" autocomplete="off" />
      </div>
      <button class="chat-send" type="button" onclick="searchRestaurants()">ğŸ” æœå°‹é¤å»³</button>
      <div class="example-text">
        ğŸ’¡ æç¤ºï¼šåœ°å€å¯ä»¥æ˜¯è©³ç´°åœ°å€ã€åœ°æ¨™åç¨±ï¼Œç”šè‡³æ˜¯ Google Maps åˆ†äº«çš„çŸ­ç¶²å€
      </div>
    </div>
  </div>

  <script>
    const chatMessages = document.getElementById('chat-messages');
    const locationInput = document.getElementById('location-input');
    const keywordInput = document.getElementById('keyword-input');

    function appendMsg(content, sender) {
      const div = document.createElement('div');
      div.className = 'msg ' + sender;
      div.innerHTML = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return div;
    }

    function formatRestaurant(restaurant) {
      let html = `<div class="restaurant-card">`;
      html += `<div class="restaurant-name">ğŸ½ï¸ ${restaurant.name || 'æœªçŸ¥é¤å»³'}</div>`;
      
      let infoItems = [];
      if (restaurant.address) {
        infoItems.push(`ğŸ“ ${restaurant.address}`);
      }
      if (restaurant.distance) {
        infoItems.push(`ğŸ“ ${restaurant.distance}`);
      } else if (restaurant.distance_km !== null && restaurant.distance_km !== undefined) {
        infoItems.push(`ğŸ“ è·é›¢ <span class="restaurant-distance">${restaurant.distance_km} å…¬é‡Œ</span>`);
      }
      if (restaurant.rating) {
        infoItems.push(`â­ è©•åˆ† <span class="restaurant-rating">${restaurant.rating}</span>`);
      }
      if (restaurant.price_level) {
        infoItems.push(`ğŸ’° åƒ¹æ ¼ ${restaurant.price_level}`);
      }
      
      if (infoItems.length > 0) {
        html += `<div class="restaurant-info">${infoItems.join('<br>')}</div>`;
      }
      // ç‡Ÿæ¥­ç‹€æ…‹/ç‡Ÿæ¥­æ™‚é–“
      const openNow = restaurant.open_now;
      const statusText = restaurant.hours_status || '';
      let badgeClass = 'badge-unknown';
      let badgeText = 'ç‡Ÿæ¥­è³‡è¨ŠæœªçŸ¥';
      if (openNow === true) { badgeClass = 'badge-open'; badgeText = 'ç‡Ÿæ¥­ä¸­'; }
      else if (openNow === false) { badgeClass = 'badge-closed'; badgeText = 'ä¼‘æ¯ä¸­'; }
      else if (statusText.includes('24 å°æ™‚')) { badgeClass = 'badge-open'; badgeText = '24 å°æ™‚ç‡Ÿæ¥­'; }
      html += `<div class="hours-row"><span class="badge ${badgeClass}">${badgeText}</span>${statusText ? `<span>${statusText}</span>` : ''}</div>`;
      
      const mapsLink = restaurant.google_maps_url || restaurant.maps_url;
      if (mapsLink) {
        html += `<div style="margin-top: 0.8em;">`;
        html += `<a href="${mapsLink}" target="_blank" class="restaurant-link">ğŸ—ºï¸ åœ¨ Google Maps ä¸­æŸ¥çœ‹</a>`;
        html += `</div>`;
      }
      
      html += `</div>`;
      return html;
    }

    async function searchRestaurants() {
      const location = locationInput.value.trim();
      const keyword = keywordInput.value.trim();
      
      if (!location && !keyword) {
        appendMsg('âŒ è«‹è‡³å°‘è¼¸å…¥åœ°å€æˆ–é£Ÿç‰©é¡å‹ï¼', 'bot');
        return;
      }
      
      // é¡¯ç¤ºä½¿ç”¨è€…è¼¸å…¥
      let userMsg = '';
      if (location) userMsg += `ğŸ“ ${location}`;
      if (location && keyword) userMsg += '<br>';
      if (keyword) userMsg += `ğŸ´ ${keyword}`;
      
      appendMsg(userMsg, 'user');
      
      // é¡¯ç¤ºè¼‰å…¥è¨Šæ¯
      const loadingMsg = appendMsg('ğŸ” æ­£åœ¨æœå°‹é™„è¿‘çš„ç¾å‘³é¤å»³...', 'bot');
      
      try {
        // å»ºæ§‹ API è«‹æ±‚
        const params = new URLSearchParams();
        if (keyword) params.append('keyword', keyword);
        if (location) params.append('user_address', location);
        params.append('max_results', '8');
        
        const response = await fetch(`http://localhost:5000/restaurants?${params.toString()}`);
        
        if (!response.ok) {
          throw new Error(`API è«‹æ±‚å¤±æ•— (${response.status})`);
        }
        
        const data = await response.json();
        
        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        loadingMsg.remove();
        
        if (!data.restaurants || data.restaurants.length === 0) {
          appendMsg('ğŸ˜… å¾ˆæŠ±æ­‰ï¼Œæ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³ã€‚<br>å»ºè­°ï¼š<br>â€¢ å˜—è©¦æ›´å¯¬æ³›çš„é—œéµå­—<br>â€¢ æª¢æŸ¥åœ°å€æ˜¯å¦æ­£ç¢º<br>â€¢ å˜—è©¦ä¸åŒçš„é£Ÿç‰©é¡å‹', 'bot');
          return;
        }
        
        // é¡¯ç¤ºæœå°‹çµæœ
        let resultMsg = `ğŸ‰ æ‰¾åˆ° ${data.restaurants.length} å®¶é¤å»³ï¼š<br><br>`;
        data.restaurants.forEach((restaurant, index) => {
          resultMsg += formatRestaurant(restaurant);
        });
        
        appendMsg(resultMsg, 'bot');
        
        // æ¸…ç©ºè¼¸å…¥æ¡†
        keywordInput.value = '';
        locationInput.value = '';
        
      } catch (error) {
        console.error('æœå°‹éŒ¯èª¤:', error);
        loadingMsg.innerHTML = `âŒ æœå°‹å¤±æ•—ï¼š${error.message}<br><br>è«‹æª¢æŸ¥ï¼š<br>â€¢ ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br>â€¢ ä¼ºæœå™¨æ˜¯å¦å•Ÿå‹•<br>â€¢ è¼¸å…¥æ ¼å¼æ˜¯å¦æ­£ç¢º`;
      }
    }

    // æ”¯æ´ Enter éµæœå°‹
    locationInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchRestaurants();
      }
    });

    keywordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchRestaurants();
      }
    });

    // é é¢è¼‰å…¥å®Œæˆå¾Œèšç„¦åˆ°åœ°å€è¼¸å…¥æ¡†
    window.onload = function() {
      locationInput.focus();
    };
  </script>
</body>
</html>
