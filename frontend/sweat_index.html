<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµæ±—æŒ‡æ•¸æŸ¥è©¢ç³»çµ±</title>
  <style>
    body { background: linear-gradient(120deg, #fff3e0 0%, #ffe8cc 100%); margin: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    .chat-container { max-width: 480px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; padding: 0; display: flex; flex-direction: column; height: 85vh; }
    .chat-header { padding: 1.2em 1.5em; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: #fff; border-radius: 16px 16px 0 0; font-size: 1.3em; font-weight: bold; letter-spacing: 1px; text-align: center; }
    .chat-subtitle { padding: 0 1.5em 1em; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: #fff; font-size: 0.9em; opacity: 0.9; text-align: center; border-radius: 0 0 16px 16px; margin-bottom: 1em; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 0 1.5em 1.5em; display: flex; flex-direction: column; gap: 1.2em; }
    .msg { max-width: 85%; padding: 1em 1.2em; border-radius: 16px; font-size: 1.05em; line-height: 1.6; }
    .msg.user { align-self: flex-end; background: #fff3e0; color: #e65100; border-bottom-right-radius: 4px; }
    .msg.bot { align-self: flex-start; background: #fff8f0; color: #222; border-bottom-left-radius: 4px; box-shadow: 0 2px 8px #0001; }
    
    /* æµæ±—æŒ‡æ•¸å¡ç‰‡æ¨£å¼ */
    .sweat-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.2em; margin: 0.8em 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .location-header { font-weight: bold; color: #ff9800; font-size: 1.2em; margin-bottom: 0.8em; display: flex; align-items: center; gap: 0.5em; }
    .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8em; margin: 0.8em 0; }
    .weather-item { background: #f8f9ff; border-radius: 8px; padding: 0.8em; text-align: center; }
    .weather-label { font-size: 0.85em; color: #666; margin-bottom: 0.3em; }
    .weather-value { font-weight: bold; font-size: 1.1em; color: #333; }
    .temperature { color: #ff5722; }
    .humidity { color: #2196f3; }
    .wind { color: #4caf50; }
    .heat-index { color: #ff9800; }
    
    /* æµæ±—æŒ‡æ•¸é¡¯ç¤º */
    .sweat-index-display { text-align: center; margin: 1em 0; padding: 1em; background: linear-gradient(135deg, #fff3e0 0%, #ffe8cc 100%); border-radius: 12px; }
    .sweat-index-title { font-size: 0.9em; color: #666; margin-bottom: 0.5em; }
    .sweat-index-value { font-size: 2.5em; font-weight: bold; margin: 0.2em 0; }
    .sweat-index-level { font-size: 1.1em; font-weight: bold; margin: 0.3em 0; }
    .sweat-index-desc { font-size: 0.9em; color: #666; }
    
    /* èˆ’é©åº¦ç­‰ç´šé¡è‰² */
    .comfort-green { color: #4caf50; }
    .comfort-lightgreen { color: #8bc34a; }
    .comfort-yellow { color: #ffc107; }
    .comfort-orange { color: #ff9800; }
    .comfort-red { color: #f44336; }
    
    /* å»ºè­°å€å¡Š */
    .advice-section { margin: 1em 0; }
    .advice-title { font-weight: bold; color: #ff9800; margin-bottom: 0.5em; }
    .advice-content { background: #f8f9ff; border-radius: 8px; padding: 0.8em; font-size: 0.95em; line-height: 1.5; }
    
    /* è­¦å ±æ¨£å¼ */
    .alert { border-radius: 8px; padding: 0.8em; margin: 0.5em 0; font-size: 0.9em; }
    .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .alert-success { background: #d1eddb; border: 1px solid #c3e6cb; color: #155724; }
    
    /* è¼¸å…¥å€åŸŸ */
    .chat-input-area { display: flex; padding: 1.2em; border-top: 1px solid #e5e7eb; background: #f7fafc; border-radius: 0 0 16px 16px; }
    .chat-input { flex: 1; padding: 0.8em 1em; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1em; outline: none; }
    .chat-send { margin-left: 0.8em; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: #fff; border: none; border-radius: 8px; padding: 0.8em 1.5em; font-size: 1em; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .chat-send:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3); }
    
    /* è¼‰å…¥å‹•ç•« */
    .loading { text-align: center; color: #666; font-style: italic; }
    .loading::after { content: ''; animation: dots 1.5s steps(5, end) infinite; }
    @keyframes dots {
      0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
      40% { color: #666; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
      60% { text-shadow: .25em 0 0 #666, .5em 0 0 rgba(0,0,0,0); }
      80%, 100% { text-shadow: .25em 0 0 #666, .5em 0 0 #666; }
    }
    
    @media (max-width: 600px) {
      .chat-container { max-width: 100vw; height: 100vh; border-radius: 0; margin: 0; }
      .chat-header, .chat-messages, .chat-input-area { padding-left: 1em; padding-right: 1em; }
      .weather-grid { grid-template-columns: 1fr; }
      .sweat-index-value { font-size: 2em; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">ğŸŒ¡ï¸ æµæ±—æŒ‡æ•¸æŸ¥è©¢ç³»çµ±</div>
    <div class="chat-subtitle">è¼¸å…¥åœ°é»æŸ¥è©¢å³æ™‚å¤©æ°£å’Œæµæ±—æŒ‡æ•¸ï¼Œè¦åŠƒèˆ’é©çš„ç”¨é¤é«”é©—ï¼</div>
    <div class="chat-messages" id="chat-messages">
      <div class="msg bot">
        æ‚¨å¥½ï¼æˆ‘æ˜¯æµæ±—æŒ‡æ•¸æŸ¥è©¢åŠ©æ‰‹ ğŸŒ¡ï¸<br><br>
        è«‹è¼¸å…¥åœ°é»ä¾†æŸ¥è©¢ï¼š<br>
        ğŸŒ¤ï¸ <strong>å³æ™‚å¤©æ°£è³‡è¨Š</strong><br>
        ğŸ’§ <strong>æµæ±—æŒ‡æ•¸åˆ†æ</strong><br>
        ğŸ½ï¸ <strong>ç”¨é¤å ´æ‰€å»ºè­°</strong><br><br>
        æ”¯æ´æ ¼å¼ï¼š<br>
        â€¢ åœ°æ¨™åç¨±ï¼šå°åŒ—101ã€å£«æ—å¤œå¸‚<br>
        â€¢ åœ°å€ï¼šå°åŒ—å¸‚ä¸­å±±å€<br>
        â€¢ ç¶“ç·¯åº¦ï¼š25.0478,121.5170<br><br>
        ğŸ’¡ æ ¹æ“šé«”æ„Ÿæº«åº¦å’Œæ¿•åº¦ç§‘å­¸è¨ˆç®—ï¼Œå¹«æ‚¨é¸æ“‡æœ€èˆ’é©çš„ç”¨é¤ç’°å¢ƒï¼
      </div>
    </div>
    <form class="chat-input-area" onsubmit="querySweatIndex(event)">
      <input class="chat-input" id="location-input" type="text" placeholder="è«‹è¼¸å…¥åœ°é»ã€åœ°å€æˆ–ç¶“ç·¯åº¦..." autocomplete="off" />
      <button class="chat-send" type="submit">ğŸ” æŸ¥è©¢</button>
    </form>
  </div>

  <script>
    const chatMessages = document.getElementById('chat-messages');
    const locationInput = document.getElementById('location-input');

    function appendMsg(content, sender) {
      const div = document.createElement('div');
      div.className = 'msg ' + sender;
      div.innerHTML = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return div;
    }

    function getComfortClass(comfortLevel) {
      const colorMap = {
        'green': 'comfort-green',
        'lightgreen': 'comfort-lightgreen', 
        'yellow': 'comfort-yellow',
        'orange': 'comfort-orange',
        'red': 'comfort-red'
      };
      return colorMap[comfortLevel] || 'comfort-yellow';
    }

    function formatSweatIndexResult(data) {
      let html = `<div class="sweat-card">`;
      
      // åœ°é»æ¨™é¡Œ
      html += `<div class="location-header">`;
      html += `ğŸ“ ${data.location || 'æŸ¥è©¢åœ°é»'}`;
      html += `</div>`;
      
      // å¤©æ°£è³‡è¨Šç¶²æ ¼
      html += `<div class="weather-grid">`;
      html += `<div class="weather-item">`;
      html += `<div class="weather-label">æº«åº¦</div>`;
      html += `<div class="weather-value temperature">${data.temperature}Â°C</div>`;
      html += `</div>`;
      html += `<div class="weather-item">`;
      html += `<div class="weather-label">æ¿•åº¦</div>`;
      html += `<div class="weather-value humidity">${data.humidity}%</div>`;
      html += `</div>`;
      if (data.wind_speed !== undefined) {
        html += `<div class="weather-item">`;
        html += `<div class="weather-label">é¢¨é€Ÿ</div>`;
        html += `<div class="weather-value wind">${data.wind_speed} m/s</div>`;
        html += `</div>`;
      }
      if (data.heat_index !== undefined) {
        html += `<div class="weather-item">`;
        html += `<div class="weather-label">é«”æ„Ÿæº«åº¦</div>`;
        html += `<div class="weather-value heat-index">${data.heat_index}Â°C</div>`;
        html += `</div>`;
      }
      html += `</div>`;
      
      // æµæ±—æŒ‡æ•¸é¡¯ç¤º
      const comfortClass = getComfortClass(data.comfort_level?.color);
      html += `<div class="sweat-index-display">`;
      html += `<div class="sweat-index-title">æµæ±—æŒ‡æ•¸</div>`;
      html += `<div class="sweat-index-value ${comfortClass}">${data.sweat_index}<span style="font-size:0.6em">/10</span></div>`;
      html += `<div class="sweat-index-level ${comfortClass}">${data.comfort_level?.level || 'æ™®é€š'}</div>`;
      html += `<div class="sweat-index-desc">${data.comfort_level?.description || ''}</div>`;
      html += `</div>`;
      
      // ç”¨é¤å»ºè­°
      if (data.venue_advice || data.drink_advice) {
        html += `<div class="advice-section">`;
        if (data.venue_preference) {
          html += `<div class="advice-title">ğŸ½ï¸ ç”¨é¤å ´æ‰€å»ºè­°</div>`;
          html += `<div class="advice-content">`;
          html += `<strong>${data.venue_preference}</strong><br>`;
          html += `${data.venue_advice}`;
          html += `</div>`;
        }
        if (data.drink_advice) {
          html += `<div class="advice-title" style="margin-top:1em">ğŸ¥¤ é£²å“å»ºè­°</div>`;
          html += `<div class="advice-content">${data.drink_advice}</div>`;
        }
        html += `</div>`;
      }
      
      // æˆ¶å¤–èˆ’é©åº¦è©•åˆ†
      if (data.outdoor_comfort_score !== undefined) {
        html += `<div class="advice-section">`;
        html += `<div class="advice-title">ğŸŒ æˆ¶å¤–èˆ’é©åº¦</div>`;
        html += `<div class="advice-content">`;
        html += `è©•åˆ†ï¼š<strong>${data.outdoor_comfort_score}/10</strong> `;
        if (data.outdoor_comfort_score >= 7) {
          html += `<span class="comfort-green">éå¸¸é©åˆæˆ¶å¤–æ´»å‹•</span>`;
        } else if (data.outdoor_comfort_score >= 5) {
          html += `<span class="comfort-yellow">é©åº¦æˆ¶å¤–æ´»å‹•</span>`;
        } else {
          html += `<span class="comfort-orange">å»ºè­°å®¤å…§æ´»å‹•</span>`;
        }
        html += `</div>`;
        html += `</div>`;
      }
      
      // è³‡æ–™ä¾†æº
      if (data.weather_source?.station_name) {
        html += `<div style="margin-top:1em; font-size:0.85em; color:#666; text-align:center;">`;
        html += `ğŸ“¡ è³‡æ–™ä¾†æºï¼š${data.weather_source.station_name}`;
        if (data.weather_source.distance_km !== undefined) {
          html += ` (è·é›¢ ${data.weather_source.distance_km.toFixed(1)} å…¬é‡Œ)`;
        }
        if (data.weather_source.data_time) {
          const time = new Date(data.weather_source.data_time).toLocaleString('zh-TW');
          html += `<br>ğŸ•’ è§€æ¸¬æ™‚é–“ï¼š${time}`;
        }
        html += `</div>`;
      }
      
      html += `</div>`;
      return html;
    }

    function formatAlerts(alerts) {
      if (!alerts || alerts.length === 0) return '';
      
      let html = `<div style="margin-top: 0.8em;">`;
      alerts.forEach(alert => {
        let alertClass = 'alert-success';
        if (alert.level === 'è­¦å‘Š') alertClass = 'alert-warning';
        if (alert.level === 'åš´é‡') alertClass = 'alert-danger';
        
        html += `<div class="alert ${alertClass}">`;
        html += `<strong>${alert.type}</strong>: ${alert.message}`;
        html += `</div>`;
      });
      html += `</div>`;
      return html;
    }

    async function querySweatIndex(e) {
      e.preventDefault();
      const location = locationInput.value.trim();
      
      if (!location) {
        appendMsg('âŒ è«‹è¼¸å…¥åœ°é»ï¼', 'bot');
        return;
      }
      
      // é¡¯ç¤ºä½¿ç”¨è€…è¼¸å…¥
      appendMsg(`ğŸ“ ${location}`, 'user');
      
      // é¡¯ç¤ºè¼‰å…¥è¨Šæ¯
      const loadingMsg = appendMsg('ğŸŒ¡ï¸ æ­£åœ¨æŸ¥è©¢å¤©æ°£è³‡æ–™å’Œè¨ˆç®—æµæ±—æŒ‡æ•¸<span class="loading">...</span>', 'bot');
      
      try {
        // èª¿ç”¨æµæ±—æŒ‡æ•¸æŸ¥è©¢ API
        const response = await fetch(`/sweat-index?location=${encodeURIComponent(location)}`);
        
        if (!response.ok) {
          throw new Error(`API è«‹æ±‚å¤±æ•— (${response.status})`);
        }
        
        const data = await response.json();
        
        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        loadingMsg.remove();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
        if (data.error) {
          let errorMsg = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${data.error}`;
          if (data.details?.message) {
            errorMsg += `<br><br>è©³ç´°è¨Šæ¯ï¼š${data.details.message}`;
          }
          if (data.details?.error === "ä¸­å¤®æ°£è±¡ç½² API é‡‘é‘°æœªè¨­ç½®") {
            errorMsg += `<br><br>ğŸ’¡ è«‹ç¢ºèªå·²è¨­ç½® CWB_API_KEY ç’°å¢ƒè®Šæ•¸`;
          }
          appendMsg(errorMsg, 'bot');
          return;
        }
        
        // é¡¯ç¤ºæµæ±—æŒ‡æ•¸çµæœ
        let resultMsg = formatSweatIndexResult(data);
        
        // æ·»åŠ é¢¨éšªè­¦å ±ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        if (data.temperature !== undefined && data.humidity !== undefined) {
          // é€™è£¡å¯ä»¥èª¿ç”¨è­¦å ± API æˆ–åœ¨å‰ç«¯è¨ˆç®—
          // ç‚ºäº†ç°¡åŒ–ï¼Œç›´æ¥æ ¹æ“šæ•¸å€¼é¡¯ç¤ºè­¦å ±
          const alerts = [];
          if (data.temperature >= 35) {
            alerts.push({type: 'é«˜æº«è­¦å ±', level: 'åš´é‡', message: `æ°£æº« ${data.temperature}Â°Cï¼Œæ¥µç«¯é«˜æº«ï¼Œé¿å…æˆ¶å¤–æ´»å‹•`});
          } else if (data.temperature >= 32) {
            alerts.push({type: 'é«˜æº«è­¦å ±', level: 'è­¦å‘Š', message: `æ°£æº« ${data.temperature}Â°Cï¼Œé«˜æº«ç‚ç†±ï¼Œæˆ¶å¤–æ´»å‹•éœ€é˜²æ›¬`});
          }
          
          if (data.sweat_index >= 8) {
            alerts.push({type: 'æµæ±—æŒ‡æ•¸è­¦å ±', level: 'åš´é‡', message: `æµæ±—æŒ‡æ•¸ ${data.sweat_index}/10ï¼Œæ¥µæ˜“å¤§é‡æµæ±—ï¼Œå»ºè­°å®¤å…§æ´»å‹•`});
          } else if (data.sweat_index >= 6) {
            alerts.push({type: 'æµæ±—æŒ‡æ•¸è­¦å ±', level: 'è­¦å‘Š', message: `æµæ±—æŒ‡æ•¸ ${data.sweat_index}/10ï¼Œå®¹æ˜“æµæ±—ï¼Œæ³¨æ„è£œæ°´`});
          }
          
          if (data.humidity >= 85) {
            alerts.push({type: 'æ¿•åº¦è­¦å ±', level: 'è­¦å‘Š', message: `ç›¸å°æ¿•åº¦ ${data.humidity}%ï¼Œæ‚¶ç†±æ½®æ¿•ï¼Œé«”æ„Ÿæº«åº¦è¼ƒé«˜`});
          }
          
          if (alerts.length === 0) {
            alerts.push({type: 'æ­£å¸¸', level: 'è‰¯å¥½', message: `å¤©æ°£èˆ’é©ï¼Œæµæ±—æŒ‡æ•¸ ${data.sweat_index}/10ï¼Œé©åˆæˆ¶å¤–æ´»å‹•`});
          }
          
          resultMsg += formatAlerts(alerts);
        }
        
        appendMsg(resultMsg, 'bot');
        
        // æ¸…ç©ºè¼¸å…¥æ¡†
        locationInput.value = '';
        
      } catch (error) {
        console.error('æŸ¥è©¢éŒ¯èª¤:', error);
        loadingMsg.innerHTML = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${error.message}<br><br>è«‹æª¢æŸ¥ï¼š<br>â€¢ ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br>â€¢ å¾Œç«¯ä¼ºæœå™¨æ˜¯å¦å•Ÿå‹•<br>â€¢ åœ°é»åç¨±æ˜¯å¦æ­£ç¢º`;
      }
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œèšç„¦åˆ°è¼¸å…¥æ¡†
    window.onload = function() {
      locationInput.focus();
    };
  </script>
</body>
</html>
